{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Overview","text":""},{"location":"#stripe-sync-engine","title":"Stripe Sync Engine","text":"<p>Sometimes you want to analyze your billing data using SQL. Even more importantly, you want to join your billing data to your product/business data.</p> <p>This project synchronizes your Stripe account to a PostgreSQL database. It can be a new database, or an existing PostgreSQL database.</p>"},{"location":"#how-it-works","title":"How it works","text":"<ul> <li>Creates a new schema <code>stripe</code> in a PostgreSQL database, with tables and columns matching Stripe.</li> <li>Exposes a <code>/webhooks</code> endpoint that listens to any Stripe webhooks (via the Fastify app).</li> <li>Inserts, updates, or deletes changes into the tables whenever there is a change to Stripe.</li> </ul>"},{"location":"#webhook-support","title":"Webhook Support","text":"<ul> <li> <code>balance.available</code></li> <li> <code>charge.captured</code> \ud83d\udfe2</li> <li> <code>charge.expired</code> \ud83d\udfe2</li> <li> <code>charge.failed</code> \ud83d\udfe2</li> <li> <code>charge.pending</code> \ud83d\udfe2</li> <li> <code>charge.refunded</code> \ud83d\udfe2</li> <li> <code>charge.refund.updated</code> \ud83d\udfe1 - For updates on all refunds, listen to <code>refund.updated</code> instead</li> <li> <code>charge.succeeded</code> \ud83d\udfe2</li> <li> <code>charge.updated</code> \ud83d\udfe2</li> <li> <code>charge.dispute.closed</code> \ud83d\udfe2</li> <li> <code>charge.dispute.created</code> \ud83d\udfe2</li> <li> <code>charge.dispute.funds_reinstated</code> \ud83d\udfe2</li> <li> <code>charge.dispute.funds_withdrawn</code> \ud83d\udfe2</li> <li> <code>charge.dispute.updated</code> \ud83d\udfe2</li> <li> <code>checkout.session.async_payment_failed</code> \ud83d\udfe2</li> <li> <code>checkout.session.async_payment_succeeded</code> \ud83d\udfe2</li> <li> <code>checkout.session.completed</code> \ud83d\udfe2</li> <li> <code>credit_note.created</code> \ud83d\udfe2</li> <li> <code>credit_note.updated</code> \ud83d\udfe2</li> <li> <code>credit_note.voided</code> \ud83d\udfe2</li> <li> <code>customer.created</code> \ud83d\udfe2</li> <li> <code>customer.deleted</code> \ud83d\udfe2</li> <li> <code>customer.source.created</code></li> <li> <code>customer.source.updated</code></li> <li> <code>customer.subscription.created</code> \ud83d\udfe2</li> <li> <code>customer.subscription.deleted</code> \ud83d\udfe2</li> <li> <code>customer.subscription.paused</code> \ud83d\udfe2</li> <li> <code>customer.subscription.pending_update_applied</code> \ud83d\udfe2</li> <li> <code>customer.subscription.pending_update_expired</code> \ud83d\udfe2</li> <li> <code>customer.subscription.resumed</code> \ud83d\udfe2</li> <li> <code>customer.subscription.trial_will_end</code> \ud83d\udfe2</li> <li> <code>customer.subscription.updated</code> \ud83d\udfe2</li> <li> <code>customer.tax_id.created</code> \ud83d\udfe2</li> <li> <code>customer.tax_id.deleted</code> \ud83d\udfe2</li> <li> <code>customer.tax_id.updated</code> \ud83d\udfe2</li> <li> <code>customer.updated</code> \ud83d\udfe2</li> <li> <code>invoice.created</code> \ud83d\udfe2</li> <li> <code>invoice.deleted</code> \ud83d\udfe2</li> <li> <code>invoice.finalized</code> \ud83d\udfe2</li> <li> <code>invoice.finalization_failed</code> \ud83d\udfe2</li> <li> <code>invoice.marked_uncollectible</code> \ud83d\udfe2</li> <li> <code>invoice.paid</code> \ud83d\udfe2</li> <li> <code>invoice.payment_action_required</code> \ud83d\udfe2</li> <li> <code>invoice.payment_failed</code> \ud83d\udfe2</li> <li> <code>invoice.payment_succeeded</code> \ud83d\udfe2</li> <li> <code>invoice.sent</code> \ud83d\udfe2</li> <li> <code>invoice.upcoming</code> \ud83d\udd34 - Event has no id and cannot be processed</li> <li> <code>invoice.updated</code> \ud83d\udfe2</li> <li> <code>invoice.overdue</code> \ud83d\udfe2</li> <li> <code>invoice.overpaid</code> \ud83d\udfe2</li> <li> <code>invoice.will_be_due</code> \ud83d\udfe2</li> <li> <code>invoice.voided</code> \ud83d\udfe2</li> <li> <code>issuing_authorization.request</code></li> <li> <code>issuing_card.created</code></li> <li> <code>issuing_cardholder.created</code></li> <li> <code>payment_intent.amount_capturable_updated</code> \ud83d\udfe2</li> <li> <code>payment_intent.canceled</code> \ud83d\udfe2</li> <li> <code>payment_intent.created</code> \ud83d\udfe2</li> <li> <code>payment_intent.partially_refunded</code> \ud83d\udfe2</li> <li> <code>payment_intent.payment_failed</code> \ud83d\udfe2</li> <li> <code>payment_intent.processing</code> \ud83d\udfe2</li> <li> <code>payment_intent.requires_action</code> \ud83d\udfe2</li> <li> <code>payment_intent.succeeded</code> \ud83d\udfe2</li> <li> <code>payment_method.attached</code> \ud83d\udfe2</li> <li> <code>payment_method.automatically_updated</code> \ud83d\udfe2</li> <li> <code>payment_method.detached</code> \ud83d\udfe2</li> <li> <code>payment_method.updated</code> \ud83d\udfe2</li> <li> <code>plan.created</code> \ud83d\udfe2</li> <li> <code>plan.deleted</code> \ud83d\udfe2</li> <li> <code>plan.updated</code> \ud83d\udfe2</li> <li> <code>price.created</code> \ud83d\udfe2</li> <li> <code>price.deleted</code> \ud83d\udfe2</li> <li> <code>price.updated</code> \ud83d\udfe2</li> <li> <code>product.created</code> \ud83d\udfe2</li> <li> <code>product.deleted</code> \ud83d\udfe2</li> <li> <code>product.updated</code> \ud83d\udfe2</li> <li> <code>radar.early_fraud_warning.created</code> \ud83d\udfe2</li> <li> <code>radar.early_fraud_warning.updated</code> \ud83d\udfe2</li> <li> <code>refund.created</code> \ud83d\udfe2</li> <li> <code>refund.failed</code> \ud83d\udfe2</li> <li> <code>refund.updated</code> \ud83d\udfe2</li> <li> <code>review.opened</code> \ud83d\udfe2</li> <li> <code>review.closed</code> \ud83d\udfe2</li> <li> <code>setup_intent.canceled</code> \ud83d\udfe2</li> <li> <code>setup_intent.created</code> \ud83d\udfe2</li> <li> <code>setup_intent.requires_action</code> \ud83d\udfe2</li> <li> <code>setup_intent.setup_failed</code> \ud83d\udfe2</li> <li> <code>setup_intent.succeeded</code> \ud83d\udfe2</li> <li> <code>subscription_schedule.aborted</code> \ud83d\udfe2</li> <li> <code>subscription_schedule.canceled</code> \ud83d\udfe2</li> <li> <code>subscription_schedule.completed</code> \ud83d\udfe2</li> <li> <code>subscription_schedule.created</code> \ud83d\udfe2</li> <li> <code>subscription_schedule.expiring</code> \ud83d\udfe2</li> <li> <code>subscription_schedule.released</code> \ud83d\udfe2</li> <li> <code>subscription_schedule.updated</code> \ud83d\udfe2</li> </ul>"},{"location":"contributing/","title":"Contributing","text":"<p>Contributions are welcome! This document provides guidelines for contributing to the Stripe Sync Engine project.</p>"},{"location":"contributing/#contributing-to-the-docs","title":"Contributing to the Docs","text":"<p>Building documentation requires Python 3.8+ and uv.</p>"},{"location":"contributing/#install-dependencies","title":"Install Dependencies","text":"<p>Create a virtual environment and install mkdocs, themes, and extensions using uv.</p> <pre><code>source .venv/bin/activate  # On Windows: .venv\\Scripts\\activate\nuv pip install -r docs/requirements_docs.txt\n</code></pre>"},{"location":"contributing/#serving","title":"Serving","text":"<p>To serve the documentation locally, make sure your virtual environment is activated and run:</p> <pre><code>source .venv/bin/activate  # On Windows: .venv\\Scripts\\activate\nmkdocs serve\n</code></pre> <p>and visit the docs at http://127.0.0.1:8000/</p>"},{"location":"contributing/#deploying","title":"Deploying","text":"<p>If you have write access to the repository, documentation can be updated using:</p> <pre><code>mkdocs gh-deploy\n</code></pre>"},{"location":"docker/","title":"With Docker","text":"<p>A Fastify-based server for syncing your Stripe account to a PostgreSQL database in real time. Built on top of the Stripe Sync Engine.</p>"},{"location":"docker/#features","title":"Features","text":"<ul> <li>Exposes a <code>/webhooks</code> endpoint to receive Stripe webhooks and sync data to PostgreSQL</li> <li>Supports syncing customers, invoices, products, subscriptions, and more</li> <li>Runs as a lightweight Docker container</li> <li>Designed for easy deployment to any cloud or self-hosted environment</li> </ul>"},{"location":"docker/#quick-start","title":"Quick Start","text":""},{"location":"docker/#1-pull-the-image","title":"1. Pull the image","text":"<pre><code>docker pull supabase/stripe-sync-engine:latest\n</code></pre>"},{"location":"docker/#2-run-the-container","title":"2. Run the container","text":"<pre><code>docker run -d \\\n  -e DATABASE_URL=postgres://postgres:postgres@localhost:5432/postgres \\\n  -e STRIPE_SECRET_KEY=sk_test_... \\\n  -e STRIPE_WEBHOOK_SECRET=... \\\n  -e API_KEY=\"my-secret\" \\\n  -p 8080:8080 \\\n  supabase/stripe-sync-engine:latest\n</code></pre>"},{"location":"docker/#3-configuration","title":"3. Configuration","text":"<p>Set your webhook endpoint in the Stripe dashboard to point to your server\u2019s <code>/webhooks</code> route (e.g., <code>https://yourdomain.com/webhooks</code>).</p>"},{"location":"docker/#environment-variables","title":"Environment Variables","text":"Variable Description Required <code>DATABASE_URL</code> PostgreSQL connection string (with <code>search_path=stripe</code>) Yes <code>STRIPE_WEBHOOK_SECRET</code> Stripe webhook signing secret Yes <code>API_KEY</code> API key for admin endpoints (backfilling, etc.) Yes <code>STRIPE_SECRET_KEY</code> Stripe secret key (needed for active sync/backfill) No <code>PORT</code> Port to run the server on (default: 8080) No <code>STRIPE_API_VERSION</code> Stripe API version (default: <code>2020-08-27</code>) No <code>AUTO_EXPAND_LISTS</code> Fetch all list items from Stripe (default: false) No <code>BACKFILL_RELATED_ENTITIES</code> Backfill related entities for foreign key integrity (default: true) No <code>MAX_POSTGRES_CONNECTIONS</code> Max PostgreSQL connection pool size (default: 10) No <code>REVALIDATE_OBJECTS_VIA_STRIPE_API</code> Always fetch latest entity from Stripe (default: false) No <code>DISABLE_MIGRATIONS</code> Disable the automated database migrations on app startup (default: false) No <code>PG_SSL_CONFIG_ENABLED</code> Enables SSL configuration. Set to <code>true</code> to enable No <code>PG_SSL_REJECT_UNAUTHORIZED</code> Rejects unauthorized SSL connections. Set to <code>true</code> to enforce No <code>PG_SSL_CA</code> Base64-encoded CA certificate for SSL connections No <code>PG_SSL_CERT</code> Certificate chain in PEM format for SSL connections No <code>PG_SSL_REQUEST_CERT</code> Requests a certificate from clients and attempts to verify it. Set to <code>true</code> to enable No"},{"location":"docker/#endpoints","title":"Endpoints","text":"<ul> <li><code>POST /webhooks</code> \u2014 Receives Stripe webhook events and syncs data to PostgreSQL</li> <li><code>GET /health</code> \u2014 Health check endpoint</li> <li><code>POST /sync</code> \u2014 Backfill Stripe data to PostgreSQL (API key required)</li> <li><code>POST /sync/single/:stripeId</code> \u2014 Backfill or update a single Stripe entity by ID (API key required)</li> <li><code>POST /daily</code> \u2014 Backfill data from the last 24 hours (API key required)</li> <li><code>POST /weekly</code> \u2014 Backfill data from the last 7 days (API key required)</li> <li><code>POST /monthly</code> \u2014 Backfill data from the last 30 days (API key required)</li> </ul>"},{"location":"docker/#example-docker-compose","title":"Example Docker Compose","text":"<pre><code>version: '3'\nservices:\n  postgres:\n    image: postgres:17\n    restart: always\n    environment:\n      POSTGRES_USER: postgres\n      POSTGRES_PASSWORD: postgres\n      POSTGRES_DB: postgres\n    ports:\n      - 5432:5432\n    volumes:\n      - pgdata:/var/lib/postgresql/data\n\n  stripe-sync:\n    image: supabase/stripe-sync-fastify:latest\n    depends_on:\n      - postgres\n    ports:\n      - 8080:8080\n    environment:\n      DATABASE_URL: postgres://postgres:postgres@postgres:5432/postgres?sslmode=disable&amp;search_path=stripe\n      STRIPE_SECRET_KEY: sk_test_...\n      STRIPE_WEBHOOK_SECRET: whsec_...\n      API_KEY: my-secret\n\nvolumes:\n  pgdata:\n</code></pre>"},{"location":"docker/#backfill-from-stripe","title":"Backfill from Stripe","text":"<p>Note: The <code>/sync</code> endpoints are NOT recommended for use if you have more than 10,000 objects in Stripe. For large backfills, it is best to write a script that loops through each day and sets the <code>created</code> date filters to the start and end of day.</p> <pre><code>POST /sync\nbody: {\n  \"object\": \"product\",\n  \"created\": {\n    \"gte\": 1643872333\n  }\n}\n</code></pre> <ul> <li><code>object</code> all | charge | customer | dispute | invoice | payment_method | payment_intent | plan | price | product | setup_intent | subscription | early_fraud_warning | refund | credit_note | tax_id | subscription_schedules</li> <li><code>created</code> is Stripe.RangeQueryParam. It supports gt, gte, lt, lte</li> </ul>"},{"location":"docker/#alternative-routes-to-sync-dailyweeklymonthly-data","title":"Alternative routes to sync <code>daily/weekly/monthly</code> data","text":"<pre><code>POST /sync/daily\n</code></pre> <pre><code>POST /sync/daily\nbody: {\n  \"object\": \"product\"\n}\n</code></pre>"},{"location":"docker/#syncing-single-entity","title":"Syncing single entity","text":"<p>To backfill/update a single entity, you can use:</p> <pre><code>POST /sync/single/cus_12345\n</code></pre> <p>The entity type is recognized automatically, based on the prefix.</p>"},{"location":"docker/#ssl-ca-certificate-in-base64-format","title":"SSL CA Certificate in Base64 Format","text":"<p>To pass an SSL CA certificate in base64 format for the Dockerized application, follow these steps:</p> <ol> <li>Obtain the CA certificate file (e.g., <code>prod-ca-2021.crt</code>).</li> <li>Encode it in base64 format using the following command on Unix-based systems:</li> </ol> <pre><code>base64 -i prod-ca-2021.crt -o CA.base64\n</code></pre> <ol> <li>Open the <code>CA.base64</code> file and copy its contents.</li> <li>Add the base64 string to your environment variables (e.g., <code>PG_SSL_CA</code>).</li> <li>Pass the environment variable to the Docker container:</li> </ol> <pre><code>docker run -d \\\n  -e DATABASE_URL=postgres://postgres:postgres@localhost:5432/postgres \\\n  -e PG_SSL_CA=\"$(cat CA.base64)\" \\\n  -e STRIPE_SECRET_KEY=sk_test_... \\\n  -e STRIPE_WEBHOOK_SECRET=... \\\n  -e API_KEY=\"my-secret\" \\\n  -p 8080:8080 \\\n  supabase/stripe-sync-engine:latest\n</code></pre> <p>Note: The <code>PG_SSL_CA</code> environment variable should contain the base64-encoded CA certificate. The application will decode and use it automatically during runtime.</p>"},{"location":"docker/#example-usage","title":"Example Usage","text":"<p>To pass these variables to the Docker container, use the following command:</p> <pre><code>docker run -d \\\n  -e DATABASE_URL=postgres://postgres:postgres@localhost:5432/postgres \\\n  -e PG_SSL_CONFIG_ENABLED=true \\\n  -e PG_SSL_REJECT_UNAUTHORIZED=true \\\n  -e PG_SSL_CA=\"$(cat CA.base64)\" \\\n  -e PG_SSL_CERT=\"$(cat cert.pem)\" \\\n  -e PG_SSL_REQUEST_CERT=true \\\n  -e STRIPE_SECRET_KEY=sk_test_... \\\n  -e STRIPE_WEBHOOK_SECRET=... \\\n  -e API_KEY=\"my-secret\" \\\n  -p 8080:8080 \\\n  supabase/stripe-sync-engine:latest\n</code></pre> <p>Note: Ensure the <code>PG_SSL_CA</code> and <code>PG_SSL_CERT</code> variables contain valid base64-encoded or PEM-formatted certificates as required.</p>"},{"location":"edge-function/","title":"With Supabase Edge Functions","text":"<p>Create a new Supabase project and create a new Edge Function.</p>"},{"location":"edge-function/#prepare-your-database","title":"Prepare your database","text":"<p>Make sure to run the migrations, either by executing them manually, adding them into your CI, or running this locally once:</p> <pre><code>import { runMigrations } from '@supabase/stripe-sync-engine'\n;(async () =&gt; {\n  await runMigrations({\n    databaseUrl: 'postgresql://postgres:..@db.&lt;ref&gt;.supabase.co:5432/postgre',\n    logger: console,\n  })\n})()\n</code></pre>"},{"location":"edge-function/#usage","title":"Usage","text":"<p>Sample code:</p> <pre><code>// Setup type definitions for built-in Supabase Runtime APIs\nimport 'jsr:@supabase/functions-js/edge-runtime.d.ts'\nimport { StripeSync } from 'npm:@supabase/stripe-sync-engine@0.37.2'\n\n// Load secrets from environment variables\nconst stripeWebhookSecret = Deno.env.get('STRIPE_WEBHOOK_SECRET')!\nconst stripeSecretKey = Deno.env.get('STRIPE_SECRET_KEY')!\n\n// Initialize StripeSync\nconst stripeSync = new StripeSync({\n  poolConfig: {\n    connectionString: Deno.env.get('DATABASE_URL')!,\n    max: 20,\n    keepAlive: true,\n    // optional SSL configuration\n    ssl: {\n      ca: Buffer.from(Deno.env.get('DATABASE_SSL_CA')!).toString('utf-8'),\n    },\n  },\n  stripeWebhookSecret,\n  stripeSecretKey,\n  backfillRelatedEntities: false,\n  autoExpandLists: true,\n  maxPostgresConnections: 5,\n})\n\nDeno.serve(async (req) =&gt; {\n  // Extract raw body as Uint8Array (buffer)\n  const rawBody = new Uint8Array(await req.arrayBuffer())\n\n  const stripeSignature = req.headers.get('stripe-signature')\n\n  await stripeSync.processWebhook(rawBody, stripeSignature)\n\n  return new Response(null, {\n    status: 202,\n    headers: { 'Content-Type': 'application/json' },\n  })\n})\n</code></pre> <p>Deploy your Edge Function initially.</p> <p>Set up a Stripe webhook with the newly deployed Supabase Edge Function URL.</p> <p>Create a new .env file in the <code>supabase</code> directory.</p> <pre><code>DATABASE_URL=\"postgresql://postgres:..@db.&lt;ref&gt;.supabase.co:5432/postgres\"\nDATABASE_SSL_CA=\"&lt;base64-encoded-ca&gt;\"\nSTRIPE_WEBHOOK_SECRET=\"whsec_\"\nSTRIPE_SECRET_KEY=\"sk_test_...\"\n</code></pre> <p>Load the secrets:</p> <pre><code>supabase secrets set --env-file ./supabase/.env\n</code></pre> <p>Note: Replace <code>&lt;base64-encoded-ca&gt;</code> with your actual base64-encoded certificate.</p>"},{"location":"edge-function/#generating-base64-from-ca-certificate","title":"Generating Base64 from CA Certificate","text":"<p>To generate a base64-encoded CA certificate, follow these steps:</p> <ol> <li>Obtain the CA certificate file (e.g., <code>prod-ca-2021.crt</code>).</li> <li>Use the following command on Unix-based systems:</li> </ol> <pre><code>base64 -i prod-ca-2021.crt -o CA.base64\n</code></pre> <ol> <li>Open the <code>CA.base64</code> file and copy its contents.</li> <li>Use the base64 string in your configuration or environment variables.</li> </ol>"},{"location":"postgres-schema/","title":"Stripe Sync Engine Postgres Schema","text":"<p>This document describes the PostgreSQL objects that <code>@supabase/stripe-sync-engine</code> sets up inside the <code>stripe</code> schema.</p>"},{"location":"postgres-schema/#overview","title":"Overview","text":"<ul> <li>Schema: All objects are created under the <code>stripe</code> schema.</li> <li>Sync bookkeeping:</li> <li>Migration <code>0033</code> adds a <code>last_synced_at</code> column to every sync-managed table; only a subset also carry an <code>updated_at</code> column maintained by the shared trigger.</li> <li>Sync logic writes rows via upserts with timestamp protection.</li> <li>Sync status: The <code>sync_status</code> table tracks the state of each resource\u2019s synchronization, including incremental cursor positions.</li> <li>Triggers &amp; functions:</li> <li><code>set_updated_at()</code> (migration <code>0012</code>) updates <code>updated_at</code> to <code>now()</code> on every row update.</li> <li>The trigger is attached to core tables when they are created; later tables that define their own <code>updated_at</code> also register the trigger.</li> <li>Foreign keys: Migration <code>0034</code> drops FK constraints between most tables to avoid replication deadlocks. Columns still contain Stripe IDs for manual joins, but referential integrity is unenforced. The only remaining cascading FKs are on <code>checkout_session_line_items</code> (to <code>prices</code> and <code>checkout_sessions</code>).</li> <li>Schema parity: Tables are modeled as near 1:1 copies of Stripe\u2019s REST API resources, preserving field names and shapes wherever PostgreSQL types allow.</li> </ul>"},{"location":"postgres-schema/#custom-types","title":"Custom Types","text":"Type Allowed values Notes <code>stripe.pricing_type</code> <code>one_time</code>, <code>recurring</code> <code>stripe.pricing_tiers</code> <code>graduated</code>, <code>volume</code> <code>stripe.subscription_status</code> <code>trialing</code>, <code>active</code>, <code>canceled</code>, <code>incomplete</code>, <code>incomplete_expired</code>, <code>past_due</code>, <code>unpaid</code>, <code>paused</code> Added in migration <code>0039</code>. <code>stripe.invoice_status</code> <code>draft</code>, <code>open</code>, <code>paid</code>, <code>uncollectible</code>, <code>void</code>, <code>deleted</code> Added in migration <code>0023</code>. <code>stripe.subscription_schedule_status</code> <code>not_started</code>, <code>active</code>, <code>completed</code>, <code>released</code>, <code>canceled</code>"},{"location":"postgres-schema/#tables","title":"Tables","text":"Table Key columns / attributes Indexes and notes <code>products</code> <code>id</code>, <code>object</code>, <code>active</code>, <code>description</code>, <code>metadata</code>, <code>name</code>, <code>created</code>, <code>images</code>, <code>livemode</code>, <code>package_dimensions</code>, <code>shippable</code>, <code>statement_descriptor</code>, <code>unit_label</code>, <code>updated</code> (Stripe timestamp), <code>url</code>, <code>marketing_features</code>, <code>default_price</code>, <code>updated_at</code>, <code>last_synced_at</code> <code>customers</code> <code>id</code>, <code>object</code>, <code>address</code>, <code>description</code>, <code>email</code>, <code>metadata</code>, <code>name</code>, <code>phone</code>, <code>shipping</code>, <code>balance</code>, <code>created</code>, <code>currency</code>, <code>default_source</code>, <code>delinquent</code>, <code>discount</code>, <code>invoice_prefix</code>, <code>invoice_settings</code>, <code>livemode</code>, <code>next_invoice_sequence</code>, <code>preferred_locales</code>, <code>tax_exempt</code>, <code>deleted</code> (boolean, default <code>false</code>), <code>updated_at</code>, <code>last_synced_at</code> <code>prices</code> <code>id</code>, <code>object</code>, <code>active</code>, <code>currency</code>, <code>metadata</code>, <code>nickname</code>, <code>recurring</code>, <code>type</code> (<code>pricing_type</code>), <code>unit_amount</code>, <code>billing_scheme</code>, <code>created</code>, <code>livemode</code>, <code>lookup_key</code>, <code>tiers_mode</code> (<code>pricing_tiers</code>), <code>transform_quantity</code>, <code>unit_amount_decimal</code>, <code>product</code>, <code>updated_at</code>, <code>last_synced_at</code> <code>plans</code> <code>id</code>, <code>object</code>, <code>active</code>, <code>amount</code>, <code>created</code>, <code>product</code>, <code>currency</code>, <code>interval</code>, <code>livemode</code>, <code>metadata</code>, <code>nickname</code>, <code>tiers_mode</code>, <code>usage_type</code>, <code>billing_scheme</code>, <code>interval_count</code>, <code>aggregate_usage</code>, <code>transform_usage</code>, <code>trial_period_days</code>, <code>updated_at</code>, <code>last_synced_at</code> <code>subscriptions</code> <code>id</code>, <code>object</code>, <code>cancel_at_period_end</code>, <code>current_period_end</code>, <code>current_period_start</code>, <code>default_payment_method</code>, <code>items</code> (JSON), <code>metadata</code>, <code>pending_setup_intent</code>, <code>pending_update</code>, <code>status</code> (<code>subscription_status</code>), <code>application_fee_percent</code>, <code>billing_cycle_anchor</code>, <code>billing_thresholds</code>, <code>cancel_at</code>, <code>canceled_at</code>, <code>collection_method</code>, <code>created</code>, <code>days_until_due</code>, <code>default_source</code>, <code>default_tax_rates</code>, <code>discount</code>, <code>ended_at</code>, <code>livemode</code>, <code>next_pending_invoice_item_invoice</code>, <code>pause_collection</code>, <code>pending_invoice_item_interval</code>, <code>start_date</code>, <code>transfer_data</code>, <code>trial_end</code>, <code>trial_start</code>, <code>schedule</code>, <code>customer</code>, <code>latest_invoice</code>, <code>plan</code>, <code>updated_at</code>, <code>last_synced_at</code> <code>subscription_items</code> <code>id</code>, <code>object</code>, <code>billing_thresholds</code>, <code>created</code>, <code>deleted</code> (boolean), <code>metadata</code>, <code>quantity</code>, <code>price</code>, <code>subscription</code>, <code>tax_rates</code>, <code>current_period_end</code>, <code>current_period_start</code>, <code>last_synced_at</code> FK constraints removed in migration <code>0034</code>. <code>subscription_schedules</code> <code>id</code>, <code>object</code>, <code>application</code>, <code>canceled_at</code>, <code>completed_at</code>, <code>created</code>, <code>current_phase</code>, <code>customer</code>, <code>default_settings</code>, <code>end_behavior</code>, <code>livemode</code>, <code>metadata</code>, <code>phases</code>, <code>released_at</code>, <code>released_subscription</code>, <code>status</code> (<code>subscription_schedule_status</code>), <code>subscription</code>, <code>test_clock</code>, <code>last_synced_at</code> <code>invoices</code> Stripe invoice payload plus <code>customer</code>, <code>subscription</code>, <code>payment_intent</code>, <code>default_payment_method</code>, <code>default_source</code>, <code>on_behalf_of</code>, <code>charge</code>, <code>updated_at</code>, <code>last_synced_at</code> Indexes: <code>stripe_invoices_customer_idx</code>, <code>stripe_invoices_subscription_idx</code>. Status enum includes <code>deleted</code>. <code>charges</code> <code>id</code>, <code>object</code>, <code>paid</code>, <code>order</code>, <code>amount</code>, <code>review</code>, <code>source</code>, <code>status</code>, <code>created</code>, <code>dispute</code>, <code>invoice</code>, <code>outcome</code>, <code>refunds</code>, <code>updated</code> (Stripe timestamp), <code>captured</code>, <code>currency</code>, <code>customer</code>, <code>livemode</code>, <code>metadata</code>, <code>refunded</code>, <code>shipping</code>, <code>application</code>, <code>description</code>, <code>destination</code>, <code>failure_code</code>, <code>on_behalf_of</code>, <code>fraud_details</code>, <code>receipt_email</code>, <code>payment_intent</code>, <code>receipt_number</code>, <code>transfer_group</code>, <code>amount_refunded</code>, <code>application_fee</code>, <code>failure_message</code>, <code>source_transfer</code>, <code>balance_transaction</code>, <code>statement_descriptor</code>, <code>payment_method_details</code>, <code>updated_at</code>, <code>last_synced_at</code> <code>refunds</code> <code>id</code>, <code>object</code>, <code>amount</code>, <code>balance_transaction</code>, <code>charge</code>, <code>created</code>, <code>currency</code>, <code>destination_details</code>, <code>metadata</code>, <code>payment_intent</code>, <code>reason</code>, <code>receipt_number</code>, <code>source_transfer_reversal</code>, <code>status</code>, <code>transfer_reversal</code>, <code>updated_at</code>, <code>last_synced_at</code> Indexes: <code>stripe_refunds_charge_idx</code>, <code>stripe_refunds_payment_intent_idx</code>. <code>credit_notes</code> <code>id</code>, <code>object</code>, <code>amount</code>, <code>amount_shipping</code>, <code>created</code>, <code>currency</code>, <code>customer</code>, <code>customer_balance_transaction</code>, <code>discount_amount</code>, <code>discount_amounts</code>, <code>invoice</code>, <code>lines</code>, <code>livemode</code>, <code>memo</code>, <code>metadata</code>, <code>number</code>, <code>out_of_band_amount</code>, <code>pdf</code>, <code>reason</code>, <code>refund</code>, <code>shipping_cost</code>, <code>status</code>, <code>subtotal</code>, <code>subtotal_excluding_tax</code>, <code>tax_amounts</code>, <code>total</code>, <code>total_excluding_tax</code>, <code>type</code>, <code>voided_at</code>, <code>last_synced_at</code> Indexes: <code>stripe_credit_notes_customer_idx</code>, <code>stripe_credit_notes_invoice_idx</code>. <code>disputes</code> <code>id</code>, <code>object</code>, <code>amount</code>, <code>charge</code>, <code>reason</code>, <code>status</code>, <code>created</code>, <code>currency</code>, <code>evidence</code>, <code>livemode</code>, <code>metadata</code>, <code>evidence_details</code>, <code>balance_transactions</code>, <code>is_charge_refundable</code>, <code>payment_intent</code>, <code>updated_at</code>, <code>last_synced_at</code> Index: <code>stripe_dispute_created_idx</code> on <code>created</code>. <code>events</code> <code>id</code>, <code>object</code>, <code>data</code>, <code>type</code>, <code>created</code>, <code>request</code>, <code>updated</code>, <code>livemode</code>, <code>api_version</code>, <code>pending_webhooks</code>, <code>updated_at</code>, <code>last_synced_at</code> <code>payouts</code> <code>id</code>, <code>object</code>, <code>date</code>, <code>type</code>, <code>amount</code>, <code>method</code>, <code>status</code>, <code>created</code>, <code>currency</code>, <code>livemode</code>, <code>metadata</code>, <code>automatic</code>, <code>recipient</code>, <code>description</code>, <code>destination</code>, <code>source_type</code>, <code>arrival_date</code>, <code>bank_account</code>, <code>failure_code</code>, <code>transfer_group</code>, <code>amount_reversed</code>, <code>failure_message</code>, <code>source_transaction</code>, <code>balance_transaction</code>, <code>statement_descriptor</code>, <code>statement_description</code>, <code>failure_balance_transaction</code>, <code>updated_at</code>, <code>last_synced_at</code> <code>payment_intents</code> <code>id</code>, <code>object</code>, <code>amount</code>, <code>amount_capturable</code>, <code>amount_details</code>, <code>amount_received</code>, <code>application</code>, <code>application_fee_amount</code>, <code>automatic_payment_methods</code>, <code>canceled_at</code>, <code>cancellation_reason</code>, <code>capture_method</code>, <code>client_secret</code>, <code>confirmation_method</code>, <code>created</code>, <code>currency</code>, <code>customer</code>, <code>description</code>, <code>invoice</code>, <code>last_payment_error</code>, <code>livemode</code>, <code>metadata</code>, <code>next_action</code>, <code>on_behalf_of</code>, <code>payment_method</code>, <code>payment_method_options</code>, <code>payment_method_types</code>, <code>processing</code>, <code>receipt_email</code>, <code>review</code>, <code>setup_future_usage</code>, <code>shipping</code>, <code>statement_descriptor</code>, <code>statement_descriptor_suffix</code>, <code>status</code>, <code>transfer_data</code>, <code>transfer_group</code>, <code>last_synced_at</code> Indexes: <code>stripe_payment_intents_customer_idx</code>, <code>stripe_payment_intents_invoice_idx</code>. <code>payment_methods</code> <code>id</code>, <code>object</code>, <code>created</code>, <code>customer</code>, <code>type</code>, <code>billing_details</code>, <code>metadata</code>, <code>card</code>, <code>last_synced_at</code> Index: <code>stripe_payment_methods_customer_idx</code>. <code>setup_intents</code> <code>id</code>, <code>object</code>, <code>created</code>, <code>customer</code>, <code>description</code>, <code>payment_method</code>, <code>status</code>, <code>usage</code>, <code>cancellation_reason</code>, <code>latest_attempt</code>, <code>mandate</code>, <code>single_use_mandate</code>, <code>on_behalf_of</code>, <code>last_synced_at</code> Index: <code>stripe_setup_intents_customer_idx</code>. <code>tax_ids</code> <code>id</code>, <code>object</code>, <code>country</code>, <code>customer</code>, <code>type</code>, <code>value</code>, <code>created</code>, <code>livemode</code>, <code>owner</code>, <code>last_synced_at</code> Index: <code>stripe_tax_ids_customer_idx</code>. <code>early_fraud_warnings</code> <code>id</code>, <code>object</code>, <code>actionable</code>, <code>charge</code>, <code>created</code>, <code>fraud_type</code>, <code>livemode</code>, <code>payment_intent</code>, <code>updated_at</code>, <code>last_synced_at</code> Indexes: <code>stripe_early_fraud_warnings_charge_idx</code>, <code>stripe_early_fraud_warnings_payment_intent_idx</code>. <code>reviews</code> <code>id</code>, <code>object</code>, <code>billing_zip</code>, <code>charge</code>, <code>created</code>, <code>closed_reason</code>, <code>livemode</code>, <code>ip_address</code>, <code>ip_address_location</code>, <code>open</code>, <code>opened_reason</code>, <code>payment_intent</code>, <code>reason</code>, <code>session</code>, <code>updated_at</code>, <code>last_synced_at</code> Indexes: <code>stripe_reviews_charge_idx</code>, <code>stripe_reviews_payment_intent_idx</code>. <code>coupons</code> <code>id</code>, <code>object</code>, <code>name</code>, <code>valid</code>, <code>created</code>, <code>updated</code>, <code>currency</code>, <code>duration</code>, <code>livemode</code>, <code>metadata</code>, <code>redeem_by</code>, <code>amount_off</code>, <code>percent_off</code>, <code>times_redeemed</code>, <code>max_redemptions</code>, <code>duration_in_months</code>, <code>percent_off_precise</code>, <code>updated_at</code>, <code>last_synced_at</code> <code>checkout_sessions</code> Attributes from migration <code>0035</code>, including <code>customer</code>, <code>subscription</code>, <code>payment_intent</code>, <code>invoice</code>, plus <code>updated_at</code> trigger column and <code>last_synced_at</code> Indexes on <code>customer</code>, <code>subscription</code>, <code>payment_intent</code>, <code>invoice</code>. <code>checkout_session_line_items</code> <code>id</code>, <code>object</code>, <code>amount_discount</code>, <code>amount_subtotal</code>, <code>amount_tax</code>, <code>amount_total</code>, <code>currency</code>, <code>description</code>, <code>price</code>, <code>quantity</code>, <code>checkout_session</code>, <code>updated_at</code>, <code>last_synced_at</code> Indexes on <code>checkout_session</code> and <code>price</code>. FKs: <code>price</code> \u2192 <code>prices</code>, <code>checkout_session</code> \u2192 <code>checkout_sessions</code> (<code>ON DELETE CASCADE</code>). <code>features</code> <code>id</code>, <code>object</code>, <code>livemode</code>, <code>name</code>, <code>lookup_key</code> (unique), <code>active</code>, <code>metadata</code>, <code>updated_at</code>, <code>last_synced_at</code> <code>active_entitlements</code> <code>id</code>, <code>object</code>, <code>livemode</code>, <code>feature</code>, <code>customer</code>, <code>lookup_key</code> (unique), <code>updated_at</code>, <code>last_synced_at</code> Indexes on <code>customer</code>, <code>feature</code>. <code>sync_status</code> <code>id</code>, <code>resource</code> (Stripe object name), <code>status</code> (<code>queued</code>, <code>running</code>, <code>complete</code>, <code>error</code>), <code>last_synced_at</code>, <code>last_incremental_cursor</code>, <code>error_message</code>, <code>updated_at</code> Primary key on <code>id</code>, unique constraint on <code>resource</code> to ensure single row per table; used by the sync scheduler to resume incremental runs."},{"location":"postgres-schema/#additional-notes","title":"Additional Notes","text":"<ul> <li>All timestamp columns sourced from Stripe APIs (<code>created</code>, <code>updated</code>, etc.) are stored as integers representing UNIX seconds unless noted otherwise.</li> <li>JSON-bearing columns mirror Stripe\u2019s nested structures; application code frequently stringifies arrays before insertion to satisfy PostgreSQL JSON requirements.</li> <li>Even without FK constraints, the sync engine backfills related entities (e.g., subscriptions fetch missing customers) to keep data sets coherent.</li> </ul>"},{"location":"roadmap/","title":"Roadmap","text":""},{"location":"roadmap/#next-week","title":"Next Week","text":"<ul> <li>Allow table name to be customizable.</li> <li>Incremental CDC-style backfill to avoid re-pulling full historical datasets.</li> <li>Use JSONB for storing all of the data and allow user to create generated columns as necessary for future proofing. This ensures that read-only columns stay read-only because they are generated and also allow user to drop them without breaking the sync.</li> <li>Automatically creating and dropping webhooks</li> <li>Integration with ngrok as needed.</li> </ul>"},{"location":"roadmap/#next-month","title":"Next Month","text":"<ul> <li>Support additional data destinations such as MySQL, Firestore, and others.</li> <li>Dedicated documentation website to really demonstrate how this works, including support for PG Lite to allow it to work in the browser.</li> </ul>"},{"location":"roadmap/#future-ideas","title":"Future ideas","text":"<ul> <li>UI dashboard for monitoring sync health, failed webhooks, and retry status.</li> <li>Proxied Stripe API client that can read from the local cache first and fall back to Stripe when data is stale or missing.</li> <li>Pluggable transform layer so teams can normalize or mask Stripe data before persistence.</li> </ul>"},{"location":"typescript/","title":"With TypeScript","text":"<p>A TypeScript library to synchronize Stripe data into a PostgreSQL database, designed for use in Node.js backends and serverless environments.</p>"},{"location":"typescript/#features","title":"Features","text":"<ul> <li>Sync Stripe objects (customers, invoices, products, etc.) to your PostgreSQL database.</li> <li>Handles Stripe webhooks for real-time updates.</li> <li>Supports backfilling and entity revalidation.</li> </ul>"},{"location":"typescript/#installation","title":"Installation","text":"<pre><code>npm install @stripe-experiment/sync stripe\n# or\npnpm add @stripe-experiment/sync stripe\n# or\nyarn add @stripe-experiment/sync stripe\n</code></pre>"},{"location":"typescript/#usage","title":"Usage","text":"<pre><code>import { StripeSync } from '@stripe-experiment/sync'\n\nconst sync = new StripeSync({\n  poolConfig: {\n    connectionString: 'postgres://user:pass@host:port/db',\n    max: 10, // Maximum number of connections\n  },\n  stripeSecretKey: 'sk_test_...',\n  stripeWebhookSecret: 'whsec_...',\n  // logger: &lt;a pino logger&gt;\n})\n\n// Example: process a Stripe webhook\nawait sync.processWebhook(payload, signature)\n</code></pre>"},{"location":"typescript/#configuration","title":"Configuration","text":"Option Type Description <code>databaseUrl</code> string Deprecated: Use <code>poolConfig</code> with a connection string instead. <code>stripeSecretKey</code> string Stripe secret key <code>stripeWebhookSecret</code> string Stripe webhook signing secret <code>stripeApiVersion</code> string Stripe API version (default: <code>2020-08-27</code>) <code>autoExpandLists</code> boolean Fetch all list items from Stripe (not just the default 10) <code>backfillRelatedEntities</code> boolean Ensure related entities are present for foreign key integrity <code>revalidateObjectsViaStripeApi</code> Array Always fetch latest entity from Stripe instead of trusting webhook payload, possible values: charge, credit_note, customer, dispute, invoice, payment_intent, payment_method, plan, price, product, refund, review, radar.early_fraud_warning, setup_intent, subscription, subscription_schedule, tax_id <code>poolConfig</code> object Configuration for the PostgreSQL connection pool. Supports options like <code>connectionString</code>, <code>max</code>, and <code>keepAlive</code>. <code>maxPostgresConnections</code> number Deprecated: Use <code>poolConfig.max</code> instead to configure the maximum number of PostgreSQL connections. <code>logger</code> Logger Logger instance (pino)"},{"location":"typescript/#example-poolconfig","title":"Example <code>poolConfig</code>","text":"<pre><code>const config = {\n  poolConfig: {\n    connectionString: 'postgresql://user:password@localhost:5432/mydb',\n    max: 20, // Maximum number of connections\n    keepAlive: true, // Keep connections alive\n  },\n}\n</code></pre> <p>For more details, refer to the Node-Postgres Pool API documentation.</p>"},{"location":"typescript/#ssl-ca-certificate-in-base64-format","title":"SSL CA Certificate in Base64 Format","text":"<pre><code>const config = {\n  poolConfig: {\n    // optional SSL configuration\n    ssl: {\n      ca: Buffer.from(process.env.SSL_CA_CERT).toString('utf-8'),\n    },\n  },\n}\n</code></pre> <p>Note: Replace <code>&lt;base64-encoded-ca&gt;</code> with your actual base64-encoded certificate (development only) or the environment variable containing it (recommended for production).</p>"},{"location":"typescript/#generating-base64-from-ca-certificate","title":"Generating Base64 from CA Certificate","text":"<p>To generate a base64-encoded CA certificate, follow these steps:</p> <ol> <li>Obtain the CA certificate file (e.g., <code>prod-ca-2021.crt</code>).</li> <li>Use the following command on Unix-based systems:</li> </ol> <pre><code>base64 -i prod-ca-2021.crt -o CA.base64\n</code></pre> <ol> <li>Open the <code>CA.base64</code> file and copy its contents.</li> <li>Use the base64 string in your configuration or environment variables.</li> </ol>"},{"location":"typescript/#database-schema","title":"Database Schema","text":"<p>The library will create and manage a <code>stripe</code> schema in your PostgreSQL database, with tables for all supported Stripe objects (products, customers, invoices, etc.). The column layout closely mirrors Stripe's REST API payloads, so the database is effectively an on-disk copy of Stripe's schema. A companion <code>sync_status</code> table keeps a single row per Stripe resource to record synchronization state, including last incremental cursors, job status (<code>queued</code>, <code>running</code>, <code>complete</code>, <code>error</code>), and any failure details used for retries.</p> <p>Important: The library uses a fixed schema name of <code>stripe</code>. This cannot be configured as the SQL migrations hardcode this schema name.</p>"},{"location":"typescript/#migrations","title":"Migrations","text":"<p>Migrations are included in the <code>db/migrations</code> directory. You can run them using the provided <code>runMigrations</code> function:</p> <pre><code>import { runMigrations } from '@stripe-experiment/sync'\n\nawait runMigrations({ databaseUrl: 'postgres://...' })\n</code></pre>"},{"location":"typescript/#backfilling-and-syncing-data","title":"Backfilling and Syncing Data","text":""},{"location":"typescript/#syncing-a-single-entity","title":"Syncing a Single Entity","text":"<p>You can sync or update a single Stripe entity by its ID using the <code>syncSingleEntity</code> method:</p> <pre><code>await sync.syncSingleEntity('cus_12345')\n</code></pre> <p>The entity type is detected automatically based on the Stripe ID prefix (e.g., <code>cus_</code> for customer, <code>prod_</code> for product).</p>"},{"location":"typescript/#syncing-entire-tables","title":"Syncing entire tables","text":"<p>Every Stripe resource sync is resumable and identifiably incremental. The engine stores per-table state in <code>stripe.sync_status</code>, which records the last incremental cursor, job status, and any failure context. When a sync restarts, it reads the previous cursor and continues without reprocessing completed windows.</p> <ul> <li>Idempotent checkpoints: Each batch writes its ending Stripe pagination cursor before advancing, and every row is upserted with Stripe IDs plus <code>last_synced_at</code> guards. Replaying the same window simply reasserts the latest data without duplication.</li> <li>Interruptible runs: You can stop the worker at any time; the next run resumes from the recorded cursor with no duplicated rows thanks to upserts guarded by <code>last_synced_at</code>.</li> <li>Selectable scope: Schedule incremental jobs per Stripe resource (e.g., invoices, subscriptions) or run them all; the engine guarantees the last-known state is preserved independently for each.</li> <li>Error recovery: When a batch fails, the engine marks the status as <code>error</code> and preserves the cursor. Fix the issue and rerun to pick up exactly where it stopped.</li> <li>Incremental backfill: Initial backfills simply seed the cursor to the earliest desired timestamp and let the incremental runner stream forward, so the same resumable machinery powers ongoing syncs and historical loads without separate code paths.</li> </ul>"},{"location":"typescript/#typescript-api-reference","title":"TypeScript API Reference","text":"<pre><code>// Resume or start a backfill using incremental sync semantics\nawait sync.startResumableSync({\n  object: 'product',\n  created: { gte: 1643872333 }, // Unix timestamp cursor seed\n})\n</code></pre> <ul> <li><code>startResumableSync(options)</code> seeds the incremental cursor based on the filters you pass (<code>object</code>, <code>created</code>, etc.) and then streams forward, updating <code>stripe.sync_status</code> as batches finish.</li> <li><code>syncSingleEntity(id)</code> revalidates a single Stripe resource and is safe to call repeatedly; updates are idempotent.</li> </ul> <p>Note: For large Stripe accounts (more than 10,000 objects), it is recommended to write a script that loops through each day and sets the <code>created</code> date filters to the start and end of day. This avoids timeouts and memory issues when syncing large datasets.</p>"}]}